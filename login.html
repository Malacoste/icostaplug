<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iCOSTA - Secure Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    
    <!-- Security Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        :root {
            --icosta-green: #32CD32;
            --dark-bg: #111;
            --card-bg: #1a1a1a;
            --error-red: #ff4444;
            --success-green: #32CD32;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        }
        
        .login-container {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 25px rgba(50, 205, 50, 0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(50, 205, 50, 0.2);
        }
        
        .logo-container {
            margin: 0 auto 20px;
            max-width: 200px;
        }
        
        .logo {
            width: 100%;
            height: auto;
            border-radius: 12px;
            border: 2px solid var(--icosta-green);
        }
        
        h1 {
            color: var(--icosta-green);
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(50, 205, 50, 0.5);
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        input {
            width: 100%;
            padding: 12px;
            background: #222;
            border: 1px solid #333;
            border-radius: 5px;
            color: white;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: var(--icosta-green);
        }
        
        .btn-login {
            background: var(--icosta-green);
            color: #000;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 18px;
            width: 100%;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }
        
        .btn-login:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--icosta-green);
        }
        
        .btn-login:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .message {
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }
        
        .error {
            background: #442222;
            color: #ff6666;
            border-left: 4px solid var(--error-red);
        }
        
        .success {
            background: #224422;
            color: #66ff66;
            border-left: 4px solid var(--success-green);
        }
        
        .whatsapp-option {
            margin-top: 20px;
            padding: 15px;
            background: #222;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #333;
        }
        
        .whatsapp-option:hover {
            background: #2a2a2a;
            border-color: #25D366;
        }
        
        .powered-by {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
        }
        
        .language-selector {
            position: absolute;
            top: 15px;
            right: 15px;
        }
        
        .language-selector select {
            background: #222;
            color: white;
            border: 1px solid #333;
            padding: 5px;
            border-radius: 4px;
        }
        
        .form-toggle {
            margin-top: 20px;
            color: #999;
            cursor: pointer;
        }
        
        .form-toggle span {
            color: var(--icosta-green);
            text-decoration: underline;
        }
        
        .password-strength {
            height: 5px;
            margin-top: 8px;
            border-radius: 3px;
            transition: all 0.3s;
        }
        
        .weak { background: #ff4444; width: 33%; }
        .medium { background: #ffcc00; width: 66%; }
        .strong { background: #00c851; width: 100%; }
        
        .security-note {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        /* Verification Code Section */
        .verification-section {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #222;
            border-radius: 8px;
            border-left: 4px solid var(--icosta-green);
        }
        
        .verification-inputs {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin: 15px 0;
        }
        
        .verification-inputs input {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            flex: 1;
        }
        
        .resend-code {
            color: var(--icosta-green);
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .resend-code:hover {
            text-decoration: underline;
        }
        
        /* Recaptcha Container */
        #recaptcha-container {
            margin: 15px 0;
        }
        
        @media (max-width: 480px) {
            .login-container {
                padding: 20px;
            }
            
            body {
                padding: 10px;
            }
            
            .verification-inputs {
                gap: 5px;
            }
            
            .verification-inputs input {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="language-selector">
        <select id="language">
            <option value="en">English</option>
            <option value="zu">Zulu</option>
            <option value="xh">Xhosa</option>
            <option value="af">Afrikaans</option>
        </select>
    </div>

    <div class="login-container">
        <div class="logo-container">
            <img src="https://i.imgur.com/Rs7AkMV.png" class="logo" alt="iCOSTA Logo" onerror="handleLoginLogoError(this)">
        </div>
        
        <h1 id="form-title">WELCOME TO iCOSTA</h1>
        <p id="form-subtitle">Enter your phone number to get started</p>
        
        <form id="auth-form">
            <div class="form-group">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" placeholder="e.g. 067 250 5124" oninput="formatPhoneNumber(this)" required
                    pattern="[0-9\s]{10,}" title="Please enter a valid phone number">
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password" required
                    minlength="6" oninput="checkPasswordStrength(this.value)">
                <div id="password-strength" class="password-strength"></div>
                <div class="security-note">Minimum 6 characters required</div>
            </div>
            
            <div id="confirm-password-group" class="form-group" style="display: none;">
                <label for="confirm-password">Confirm Password</label>
                <input type="password" id="confirm-password" placeholder="Confirm your password">
            </div>
            
            <!-- Recaptcha Container -->
            <div id="recaptcha-container"></div>
            
            <div id="message" class="message"></div>
            
            <button type="submit" class="btn-login" id="submit-btn">CONTINUE</button>
        </form>
        
        <!-- Verification Code Section -->
        <div id="verification-section" class="verification-section">
            <h3>Enter Verification Code</h3>
            <p>We've sent a 6-digit code to your phone</p>
            
            <div class="verification-inputs">
                <input type="text" id="verification-digit-1" maxlength="1" oninput="moveToNext(1)" pattern="[0-9]">
                <input type="text" id="verification-digit-2" maxlength="1" oninput="moveToNext(2)" pattern="[0-9]">
                <input type="text" id="verification-digit-3" maxlength="1" oninput="moveToNext(3)" pattern="[0-9]">
                <input type="text" id="verification-digit-4" maxlength="1" oninput="moveToNext(4)" pattern="[0-9]">
                <input type="text" id="verification-digit-5" maxlength="1" oninput="moveToNext(5)" pattern="[0-9]">
                <input type="text" id="verification-digit-6" maxlength="1" oninput="moveToNext(6)" pattern="[0-9]">
            </div>
            
            <div class="resend-code" id="resend-code" onclick="resendVerificationCode()">
                Didn't receive the code? Resend
            </div>
            
            <button class="btn-login" id="verify-btn" onclick="verifyCode()" style="margin-top: 15px;">
                Verify Code
            </button>
        </div>
        
        <div class="form-toggle">
            <span id="toggle-form-text">Create an account</span>
        </div>
        
        <div class="whatsapp-option" onclick="loginWithWhatsApp()">
            <i class="fab fa-whatsapp" style="color: #25D366; margin-right: 8px;"></i>
            <strong>Continue with WhatsApp</strong>
        </div>
        
        <div class="powered-by">
            Powered by iCOSTA Tech
        </div>
    </div>

    <script>
        // Handle logo image error
        function handleLoginLogoError(img) {
            console.log('Login logo failed to load, using fallback');
            img.onerror = null;
            img.src = 'https://i.imgur.com/Rs7AkMV.png';
        }

        // Security configuration
        const SECURITY_CONFIG = {
            PBKDF2_ITERATIONS: 100000,
            KEY_SIZE: 256 / 32,
            SALT_BYTES: 16
        };

        // Initialize variables
        let isSignupMode = false;
        let loginAttempts = 0;
        let confirmationResult = null;
        let recaptchaVerifier = null;
        let resendTimer = null;
        let resendTimeLeft = 60;
        const MAX_LOGIN_ATTEMPTS = 5;
        const LOCKOUT_TIME = 15 * 60 * 1000; // 15 minutes
        
        // DOM elements
        const authForm = document.getElementById('auth-form');
        const formTitle = document.getElementById('form-title');
        const formSubtitle = document.getElementById('form-subtitle');
        const confirmPasswordGroup = document.getElementById('confirm-password-group');
        const toggleFormText = document.getElementById('toggle-form-text');
        const submitBtn = document.getElementById('submit-btn');
        const messageDiv = document.getElementById('message');
        const passwordStrength = document.getElementById('password-strength');
        const verificationSection = document.getElementById('verification-section');
        const resendCode = document.getElementById('resend-code');
        const recaptchaContainer = document.getElementById('recaptcha-container');
        
        // Set up language selector
        document.getElementById('language').addEventListener('change', function() {
            setLanguage(this.value);
        });
        
        // Toggle between login and signup
        toggleFormText.addEventListener('click', function() {
            isSignupMode = !isSignupMode;
            
            if (isSignupMode) {
                formTitle.textContent = 'CREATE ACCOUNT';
                formSubtitle.textContent = 'Sign up for iCOSTA rewards';
                confirmPasswordGroup.style.display = 'block';
                toggleFormText.innerHTML = 'Already have an account? <span>Login instead</span>';
                submitBtn.textContent = 'SIGN UP';
            } else {
                formTitle.textContent = 'LOGIN TO iCOSTA';
                formSubtitle.textContent = 'Enter your phone number and password';
                confirmPasswordGroup.style.display = 'none';
                toggleFormText.innerHTML = 'Need an account? <span>Create one</span>';
                submitBtn.textContent = 'LOGIN';
            }
            
            // Reset form and messages
            authForm.reset();
            hideMessage();
            passwordStrength.className = 'password-strength';
            verificationSection.style.display = 'none';
        });
        
        // Format phone number as user types
        function formatPhoneNumber(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 0) {
                value = value.match(/.{1,3}/g).join(' ');
            }
            input.value = value;
        }
        
        // Check password strength
        function checkPasswordStrength(password) {
            let strength = 0;
            
            if (password.length >= 8) strength++;
            if (password.match(/([a-z].*[A-Z])|([A-Z].*[a-z])/)) strength++;
            if (password.match(/([0-9])/)) strength++;
            if (password.match(/([!,@,#,$,%,^,&,*,?,_,~])/)) strength++;
            
            // Update strength indicator
            if (password.length === 0) {
                passwordStrength.className = 'password-strength';
            } else if (password.length < 6) {
                passwordStrength.className = 'password-strength weak';
            } else if (strength < 3) {
                passwordStrength.className = 'password-strength medium';
            } else {
                passwordStrength.className = 'password-strength strong';
            }
        }
        
        // Validate form
        function validateForm() {
            const phone = document.getElementById('phone').value.replace(/\s/g, '');
            const password = document.getElementById('password').value;
            
            // Basic validation
            if (phone.length < 10) {
                showMessage('Please enter a valid phone number', 'error');
                return false;
            }
            
            if (password.length < 6) {
                showMessage('Password must be at least 6 characters', 'error');
                return false;
            }
            
            // For signup, check password confirmation
            if (isSignupMode) {
                const confirmPassword = document.getElementById('confirm-password').value;
                if (password !== confirmPassword) {
                    showMessage('Passwords do not match', 'error');
                    return false;
                }
            }
            
            return true;
        }
        
        // Setup Recaptcha
        function setupRecaptcha() {
            try {
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                        'size': 'normal',
                        'callback': function(response) {
                            console.log('Recaptcha verified');
                        },
                        'expired-callback': function() {
                            console.log('Recaptcha expired');
                        }
                    });
                    
                    recaptchaVerifier.render().then(function(widgetId) {
                        window.recaptchaWidgetId = widgetId;
                    });
                }
            } catch (error) {
                console.error('Recaptcha setup failed:', error);
                showMessage('Security verification failed. Please refresh the page.', 'error');
            }
        }
        
        // Form submission
        authForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Check if user is temporarily locked out
            const lockoutUntil = localStorage.getItem('loginLockout');
            if (lockoutUntil && Date.now() < parseInt(lockoutUntil)) {
                const minutesLeft = Math.ceil((parseInt(lockoutUntil) - Date.now()) / 60000);
                showMessage(`Too many failed attempts. Try again in ${minutesLeft} minutes.`, 'error');
                return;
            }
            
            if (!validateForm()) {
                return;
            }
            
            const phone = document.getElementById('phone').value.replace(/\s/g, '');
            const password = document.getElementById('password').value;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = isSignupMode ? 'CREATING ACCOUNT...' : 'LOGGING IN...';
                
                // Setup recaptcha if not already done
                if (!recaptchaVerifier) {
                    setupRecaptcha();
                }
                
                if (isSignupMode) {
                    await signUp(phone, password);
                } else {
                    await login(phone, password);
                }
            } catch (error) {
                console.error('Auth error:', error);
                showMessage(error.message || 'Authentication failed', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = isSignupMode ? 'SIGN UP' : 'LOGIN';
            }
        });
        
        // Send verification code
        async function sendVerificationCode(phoneNumber) {
            try {
                if (!recaptchaVerifier) {
                    setupRecaptcha();
                }
                
                const formattedPhone = '+27' + phoneNumber.substring(1);
                confirmationResult = await firebase.auth().signInWithPhoneNumber(formattedPhone, recaptchaVerifier);
                
                // Show verification section
                verificationSection.style.display = 'block';
                authForm.style.display = 'none';
                
                // Start resend timer
                startResendTimer();
                
                showMessage('Verification code sent to your phone', 'success');
                
            } catch (error) {
                console.error('SMS not sent:', error);
                if (error.code === 'auth/invalid-phone-number') {
                    showMessage('Invalid phone number format', 'error');
                } else if (error.code === 'auth/too-many-requests') {
                    showMessage('Too many attempts. Please try again later.', 'error');
                } else {
                    showMessage('Failed to send verification code', 'error');
                }
                
                // Reset recaptcha
                if (window.recaptchaWidgetId) {
                    recaptchaVerifier.reset(window.recaptchaWidgetId);
                }
            }
        }
        
        // Verify code
        async function verifyCode() {
            try {
                const code = getVerificationCode();
                if (code.length !== 6) {
                    showMessage('Please enter a valid 6-digit code', 'error');
                    return;
                }
                
                const verifyBtn = document.getElementById('verify-btn');
                verifyBtn.disabled = true;
                verifyBtn.textContent = 'VERIFYING...';
                
                const credential = await confirmationResult.confirm(code);
                
                // User signed in successfully
                const user = credential.user;
                
                // Save user data
                await saveUserAfterVerification(user.phoneNumber);
                
                showMessage('Verification successful!', 'success');
                
                // Redirect to main page
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
                
            } catch (error) {
                console.error('Invalid code:', error);
                showMessage('Invalid verification code', 'error');
                
                const verifyBtn = document.getElementById('verify-btn');
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify Code';
            }
        }
        
        // Get verification code from inputs
        function getVerificationCode() {
            let code = '';
            for (let i = 1; i <= 6; i++) {
                code += document.getElementById('verification-digit-' + i).value;
            }
            return code;
        }
        
        // Move to next input field
        function moveToNext(current) {
            const currentInput = document.getElementById('verification-digit-' + current);
            if (currentInput.value.length === 1 && current < 6) {
                document.getElementById('verification-digit-' + (current + 1)).focus();
            }
        }
        
        // Resend verification code
        async function resendVerificationCode() {
            if (resendTimer) return;
            
            try {
                const phone = document.getElementById('phone').value.replace(/\s/g, '');
                await sendVerificationCode(phone);
                showMessage('Verification code resent', 'success');
            } catch (error) {
                console.error('Resend failed:', error);
                showMessage('Failed to resend code', 'error');
            }
        }
        
        // Start resend timer
        function startResendTimer() {
            resendTimeLeft = 60;
            resendCode.style.color = '#999';
            resendCode.style.cursor = 'default';
            resendCode.onclick = null;
            
            updateResendTimer();
            
            resendTimer = setInterval(() => {
                resendTimeLeft--;
                updateResendTimer();
                
                if (resendTimeLeft <= 0) {
                    clearInterval(resendTimer);
                    resendTimer = null;
                    resendCode.style.color = 'var(--icosta-green)';
                    resendCode.style.cursor = 'pointer';
                    resendCode.onclick = resendVerificationCode;
                    resendCode.textContent = 'Resend verification code';
                }
            }, 1000);
        }
        
        // Update resend timer display
        function updateResendTimer() {
            resendCode.textContent = `Resend code in ${resendTimeLeft}s`;
        }
        
        // Save user after verification
        async function saveUserAfterVerification(phoneNumber) {
            try {
                const phone = phoneNumber.replace('+27', '0');
                const password = document.getElementById('password').value;
                
                if (isSignupMode) {
                    await signUp(phone, password);
                } else {
                    await login(phone, password);
                }
            } catch (error) {
                console.error('Error saving user after verification:', error);
                throw error;
            }
        }
        
        // Secure password hashing
        async function hashPassword(password) {
            // Generate a random salt
            const salt = CryptoJS.lib.WordArray.random(SECURITY_CONFIG.SALT_BYTES);
            
            // Hash with PBKDF2 for key derivation
            const key = CryptoJS.PBKDF2(password, salt, {
                keySize: SECURITY_CONFIG.KEY_SIZE,
                iterations: SECURITY_CONFIG.PBKDF2_ITERATIONS
            });
            
            // Return salt + hash for storage
            return {
                salt: salt.toString(),
                hash: key.toString()
            };
        }
        
        // Verify password
        async function verifyPassword(password, salt, storedHash) {
            const key = CryptoJS.PBKDF2(password, CryptoJS.enc.Hex.parse(salt), {
                keySize: SECURITY_CONFIG.KEY_SIZE,
                iterations: SECURITY_CONFIG.PBKDF2_ITERATIONS
            });
            
            return key.toString() === storedHash;
        }
        
        // Sign up function
        async function signUp(phone, password) {
            // First send verification code
            await sendVerificationCode(phone);
        }
        
        // Login function
        async function login(phone, password) {
            // First send verification code
            await sendVerificationCode(phone);
        }
        
        // Complete sign up after verification
        async function completeSignUp(phone, password) {
            // Check if user already exists
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            
            if (users[phone]) {
                throw new Error('An account with this phone number already exists');
            }
            
            // Hash the password securely
            const { salt, hash } = await hashPassword(password);
            
            // Create new user with hashed password
            const newUser = {
                phone: phone,
                password: hash, // Store only the hash
                salt: salt,     // Store the salt
                username: phone,
                loginTime: new Date().getTime(),
                role: 'user',
                createdAt: new Date().getTime(),
                failedAttempts: 0
            };
            
            // Save to users list
            users[phone] = newUser;
            localStorage.setItem('users', JSON.stringify(users));
            
            // Set as current user (without password)
            const userForSession = { ...newUser };
            delete userForSession.password;
            delete userForSession.salt;
            
            localStorage.setItem('currentUser', JSON.stringify(userForSession));
            
            // Log signup to Firebase
            try {
                if (typeof firebase !== 'undefined' && firebase.database) {
                    const database = firebase.database();
                    await database.ref('signups').push({
                        phone: phone,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        device: navigator.userAgent
                    });
                }
            } catch (firebaseError) {
                console.warn('Firebase logging failed:', firebaseError);
            }
        }
        
        // Complete login after verification
        async function completeLogin(phone, password) {
            // Check if user exists
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const user = users[phone];
            
            if (!user) {
                throw new Error('No account found with this phone number');
            }
            
            // Check if account is locked
            if (user.lockedUntil && Date.now() < user.lockedUntil) {
                const minutesLeft = Math.ceil((user.lockedUntil - Date.now()) / 60000);
                throw new Error(`Account temporarily locked. Try again in ${minutesLeft} minutes.`);
            }
            
            // Verify password
            const isValid = await verifyPassword(password, user.salt, user.password);
            
            if (!isValid) {
                throw new Error('Incorrect password');
            }
            
            // Reset failed attempts on successful login
            user.failedAttempts = 0;
            delete user.lockedUntil;
            users[phone] = user;
            localStorage.setItem('users', JSON.stringify(users));
            
            // Update login time
            user.loginTime = new Date().getTime();
            
            // Set as current user (without password)
            const userForSession = { ...user };
            delete userForSession.password;
            delete userForSession.salt;
            
            localStorage.setItem('currentUser', JSON.stringify(userForSession));
            localStorage.setItem('users', JSON.stringify(users));
            
            // Log login to Firebase
            try {
                if (typeof firebase !== 'undefined' && firebase.database) {
                    const database = firebase.database();
                    await database.ref('logins').push({
                        phone: phone,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        device: navigator.userAgent
                    });
                }
            } catch (firebaseError) {
                console.warn('Firebase logging failed:', firebaseError);
            }
        }
        
        // Increment failed login attempts
        function incrementFailedAttempts(phone) {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            
            if (users[phone]) {
                users[phone].failedAttempts = (users[phone].failedAttempts || 0) + 1;
                
                // Lock account after too many failed attempts
                if (users[phone].failedAttempts >= MAX_LOGIN_ATTEMPTS) {
                    users[phone].lockedUntil = Date.now() + LOCKOUT_TIME;
                    showMessage(`Too many failed attempts. Account locked for 15 minutes.`, 'error');
                }
                
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            // Track global login attempts for IP-like locking
            loginAttempts++;
            if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
                localStorage.setItem('loginLockout', Date.now() + LOCKOUT_TIME);
                showMessage(`Too many failed attempts. Try again in 15 minutes.`, 'error');
            }
        }
        
        // Login with WhatsApp
        function loginWithWhatsApp() {
            const phoneInput = document.getElementById('phone');
            const phone = phoneInput.value.replace(/\s/g, '');
            
            if (phone.length < 10) {
                showMessage("Please enter a valid phone number first", 'error');
                phoneInput.focus();
                return;
            }
            
            // Check if user exists, if not create one
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            if (!users[phone]) {
                // Create a temporary user without password for WhatsApp login
                const tempUser = {
                    phone: phone,
                    username: phone,
                    loginTime: new Date().getTime(),
                    role: 'user',
                    createdAt: new Date().getTime(),
                    viaWhatsApp: true
                };
                
                users[phone] = tempUser;
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(tempUser));
            } else {
                localStorage.setItem('currentUser', JSON.stringify(users[phone]));
            }
            
            // Send WhatsApp message to iCOSTA
            const message = `Hi iCOSTA, I want to login with phone number: ${phone}`;
            window.open(`https://wa.me/27672505124?text=${encodeURIComponent(message)}`, '_blank');
            
            showMessage('WhatsApp login initiated! Redirecting...', 'success');
            
            // Redirect to main page
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        }
        
        // Show message
        function showMessage(text, type) {
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            // Auto-hide success messages
            if (type === 'success') {
                setTimeout(hideMessage, 3000);
            }
        }
        
        // Hide message
        function hideMessage() {
            messageDiv.style.display = 'none';
        }
        
        // Language support
        function setLanguage(lang) {
            const translations = {
                en: {
                    loginTitle: "LOGIN TO iCOSTA",
                    signupTitle: "CREATE ACCOUNT",
                    loginSubtitle: "Enter your phone number and password",
                    signupSubtitle: "Sign up for iCOSTA rewards",
                    phoneLabel: "Phone Number",
                    passwordLabel: "Password",
                    confirmPasswordLabel: "Confirm Password",
                    loginButton: "LOGIN",
                    signupButton: "SIGN UP",
                    toggleLogin: "Already have an account?",
                    toggleSignup: "Need an account?",
                    toggleText: "Login instead",
                    toggleText2: "Create one"
                },
                zu: {
                    loginTitle: "NGENA KU-iCOSTA",
                    signupTitle: "DALA I-AKHOWUNTI",
                    loginSubtitle: "Faka inombolo yakho yocingo nephasiwedi",
                    signupSubtitle: "Bhalisela imivuzo ye-iCOSTA",
                    phoneLabel: "Inombolo Yocingo",
                    passwordLabel: "Iphasiwedi",
                    confirmPasswordLabel: "Qinisekisa Iphasiwedi",
                    loginButton: "Ngena",
                    signupButton: "Bhalisa",
                    toggleLogin: "Senginene i-akhawunti?",
                    toggleSignup: "Udinga i-akhawunti?",
                    toggleText: "Ngena esikhundleni",
                    toggleText2: "Yakha eyakho"
                },
                xh: {
                    loginTitle: "Ngena kwi-iCOSTA",
                    signupTitle: "Yenza iAkhawunti",
                    loginSubtitle: "Faka inombolo yakho yefowuni kunye nephasiwedi",
                    signupSubtitle: "Bhalisela imivuzo ye-iCOSTA",
                    phoneLabel: "Inombolo Yefowuni",
                    passwordLabel: "Iphasiwedi",
                    confirmPasswordLabel: "Qinisekisa Iphasiwedi",
                    loginButton: "Ngena",
                    signupButton: "Bhalisa",
                    toggleLogin: "Sele ineakhawunti?",
                    toggleSignup: "Ufuna iakhawunti?",
                    toggleText: "Ngena endaweni",
                    toggleText2: "Yenza eyakho"
                },
                af: {
                    loginTitle: "Meld aan by iCOSTA",
                    signupTitle: "Skep Rekening",
                    loginSubtitle: "Voer jou foonnommer en wagwoord in",
                    signupSubtitle: "Teken aan vir iCOSTA-belonings",
                    phoneLabel: "Foonnommer",
                    passwordLabel: "Wagwoord",
                    confirmPasswordLabel: "Bevestig Wagwoord",
                    loginButton: "Meld Aan",
                    signupButton: "Teken Aan",
                    toggleLogin: "Het jy reeds 'n rekening?",
                    toggleSignup: "Benodig 'n rekening?",
                    toggleText: "Meld eerder aan",
                    toggleText2: "Skep een"
                }
            };
            
            if (translations[lang]) {
                if (isSignupMode) {
                    formTitle.textContent = translations[lang].signupTitle;
                    formSubtitle.textContent = translations[lang].signupSubtitle;
                    submitBtn.textContent = translations[lang].signupButton;
                    toggleFormText.innerHTML = `${translations[lang].toggleLogin} <span>${translations[lang].toggleText}</span>`;
                } else {
                    formTitle.textContent = translations[lang].loginTitle;
                    formSubtitle.textContent = translations[lang].loginSubtitle;
                    submitBtn.textContent = translations[lang].loginButton;
                    toggleFormText.innerHTML = `${translations[lang].toggleSignup} <span>${translations[lang].toggleText2}</span>`;
                }
                
                document.querySelector('label[for="phone"]').textContent = translations[lang].phoneLabel;
                document.querySelector('label[for="password"]').textContent = translations[lang].passwordLabel;
                
                if (isSignupMode) {
                    document.querySelector('label[for="confirm-password"]').textContent = translations[lang].confirmPasswordLabel;
                }
            }
        }
        
        // Check if already logged in
        window.addEventListener('load', () => {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (currentUser) {
                window.location.href = 'index.html';
            }
            
            // Check if lockout period has expired
            const lockoutUntil = localStorage.getItem('loginLockout');
            if (lockoutUntil && Date.now() > parseInt(lockoutUntil)) {
                localStorage.removeItem('loginLockout');
                loginAttempts = 0;
            }
            
            // Setup recaptcha
            setupRecaptcha();
            
            // Set initial language
            setLanguage('en');
        });
    </script>
</body>
</html>
